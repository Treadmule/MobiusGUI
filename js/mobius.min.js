function handleDragOver(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy",$("#drop_area").addClass("drag")}function handleDragLeave(){$("#drop_area").removeClass("drag")}function handleFileSelect(a){a.stopPropagation(),a.preventDefault();var b=a.dataTransfer.files,c=b[0],d=new FileReader;d.onloadend=function(a){if(a.target.readyState==FileReader.DONE)if(SYSCFG=a.target.result,updateParameters(),-1!=$.inArray(version,acceptedFirmware)){$("#drop_area span").removeClass("red"),$("#drop_area span").addClass("green"),$("#drop_area span").text("File loaded successfully - firmware version "+version/100),displaySettings(),userLoaded=1;for(var b=0;b<acceptedFirmware.length;b++)element="[data-minFw="+acceptedFirmware[b]+"]",version>=acceptedFirmware[b]?($(".getting_started").hide(),$(element).fadeIn(),$(element).removeAttr("disabled","disabled")):($(element).hide(),$(element).attr("disabled","disabled"))}else alert("The file you loaded was not generated by firmware v0.59 or higher.\nPlease update your camera and try again!"),parameters=defaultParameters,$("#drop_area span").removeClass("green"),$("#drop_area span").addClass("red"),$("#drop_area span").text("Wrong firmware version!")},d.readAsText(c)}function applySettings(){checkConflictsOut();for(var a=0;a<parameters.length;a++){var b=readInputValue(a);1==a||3==a?(prameterIndex=a+1,4==$("[name="+a+"]:checked").val()&&(b=3,writeParameter(prameterIndex,1),writeParameter(a,b)),$("[name="+a+"]:checked").val()<4&&(writeParameter(prameterIndex,2),writeParameter(a,b))):b&&writeParameter(a,b)}var c=readInputValue("video1Flip"),d=2*readInputValue("video2Flip"),e=c+d,e=parseInt(e,4);writeParameter(12,e),1==readInputValue("dateTime")?updateDate(0):2==readInputValue("dateTime")?updateDate(2):writeParameter(0,"????/??/??-??:??:??"),null!=navigator.userAgent.match(/Firefox/i)?SaveSYSCFG():saveWithPHP()}function displaySettings(){for(var a=0;a<parameters.length;a++)checkMinMax(a),displayParameter(a,parameters[a]);switch(3==parameters[1]&&1==parameters[2]&&displayParameter(1,4),3==parameters[3]&&1==parameters[4]&&displayParameter(3,4),parameters[12]){case"0":displayParameter("video1Flip",0),displayParameter("video2Flip",0);break;case"1":displayParameter("video1Flip",1),displayParameter("video2Flip",0);break;case"2":displayParameter("video1Flip",0),displayParameter("video2Flip",1);break;case"3":displayParameter("video1Flip",1),displayParameter("video2Flip",1)}checkConflictsIn()}function displayParameter(a,b){var c=$("[name="+a+"]");0!=c.length&&(c.is("[type=radio]")?c[b].checked=!0:c.is("[type=number]")&&("+"==b.charAt(0)?c.val(b.substring(1)):c.val(b)))}function readInputValue(a){var b=$("[name="+a+"]");if(0!=b.length){if(b.is("[type=radio]"))return 0==$("[name="+a+"]:checked").val()?"0":parseInt($("[name="+a+"]:checked").val());if(b.is("[type=number]"))return parseInt(b.attr("min"))<=parseInt(b.val())&&parseInt(b.val())<=parseInt(b.attr("max"))?0==b.val()?"0":parseInt(b.val()):(whatswrong=b.closest("div").siblings().text(),alert("One or more values entered for "+whatswrong+"\nare out of the acceptable range.\nI will replace it with the default value.\n\nThe range is: ["+b.attr("min")+";"+b.attr("max")+"]"),b.val(defaultParameters[a]),defaultParameters[a])}}function writeParameter(a,b){var c=0;SYSCFG=SYSCFG.replace(/[^[]+(?=\])/g,function(d){return c++,c==a+1?b:d}),updateParameters()}function SaveSYSCFG(){if(1==userLoaded){var a=new Blob([SYSCFG],{type:"text/plain;charset=utf-8"});saveAs(a,"SYSCFG.TXT")}else alert("You haven't successfully loaded a SYSCFG.TXT file, please also make sure your camera has firmware 0.59 or higher")}function updateParameters(){parameters=SYSCFG.match(/[^[]+(?=\])/g),version=SYSCFG.match(/v[^{]+(?=\})/g),version=parseInt(version[0].substring(1).replace(".",""),10)}function twoDigits(a){return a>9?""+a:"0"+a}function updateDate(a){var b=new Date;b.setMinutes(b.getMinutes()+a);var c=b.getFullYear(),d=b.getMonth(),e=b.getDate(),f=b.getHours(),g=b.getMinutes(),h=b.getSeconds();d=d+1+"",d=twoDigits(d),e=twoDigits(e),f=twoDigits(f),g=twoDigits(g),h=twoDigits(h);var i=[c,"/",d,"/",e,"-",f,":",g,":",h].join("");writeParameter(0,i)}function checkMinMax(a){switch(maxvalue=10,minvalue=0,a){case 2:case 4:maxvalue=2,minvalue=1;break;case 12:maxvalue=3}0!=$("[name="+a+"]").length&&($("[name="+a+"]").attr("maxval")?(maxvalue=parseInt($("[name="+a+"]").attr("maxval")),minvalue=parseInt($("[name="+a+"]").attr("minval"))):$("[name="+a+"]").attr("max")?(maxvalue=parseInt($("[name="+a+"]").attr("max")),minvalue=parseInt($("[name="+a+"]").attr("min"))):(maxvalue=$("[name="+a+"]").length-1,minvalue=0)),(parameters[a]>maxvalue||parameters[a]<minvalue)&&(parameters[a]=defaultParameters[a],console.log("wrong"+a),alert("One or more parameters from your SYSCFG.TXT file are out of their acceptable range.\nI'll use defaults instead."))}function checkConflictsIn(){1==parameters[26]&&(0!=parameters[16]||0!=parameters[6])&&(alert("Motion detection can't be used together with timelapse and/or automatic power off.\n\nMotion detection will be switched off."),displayParameter(26,0),writeParameter(26,0)),0!=parameters[6]&&(0!=parameters[17]||0!=parameters[18])&&(alert("Time lapse can't be used together with One Power Button to Auto Record and Auto Record with external power.\n\nTime lapse will be switched off."),displayParameter(6,0),writeParameter(6,0)),1==parameters[9]&&(0==parameters[8]||1==parameters[8]||(alert("Movie loop recording works only when Movie cycle time is set to 3 or 5 minutes.\n\nMovie loop recording will be switched off."),displayParameter(9,0),writeParameter(9,0)))}function checkConflictsOut(){1==readInputValue(26)&&(0!=readInputValue(16)||0!=readInputValue(6))&&(alert("Motion detection can't be used together with timelapse and/or automatic power off.\n\nMotion detection will be switched off."),displayParameter(26,0)),0!=readInputValue(6)&&(0!=readInputValue(17)||0!=readInputValue(18))&&(alert("Time lapse can't be used together with One Power Button to Auto Record and Auto Record with external power.\n\nTime lapse will be switched off."),displayParameter(6,0)),1==readInputValue(9)&&(console.log(readInputValue(8)),0==readInputValue(8)||1==readInputValue(8)||(displayParameter(9,0),alert("Movie loop recording works only when Movie cycle time is set to 3 or 5 minutes.\n\nMovie loop recording will be switched off.")))}function saveWithPHP(){$('<form action="savefile.php" method="POST"><input type="hidden" name="text" value="'+SYSCFG+'">'+"</form>").submit(),2==readInputValue("dateTime")?(clearTimeout(timeout),mins=2,secs=60*mins,countdown(),$("html, body").animate({scrollTop:0},"slow")):(clearTimeout(timeout),$("#drop_area span").text("Load your file to the camera and follow the update procedure."))}function countdown(){timeout=setTimeout("Decrement()",1e3)}function Decrement(){document.getElementById&&(0>secs?$("#drop_area span").text("Press mode + power button now!"):59>secs?$("#drop_area span").text("Load your file and get ready to press mode + power button in 00:"+twoDigits(secs)):$("#drop_area span").text("Load your file and get ready to press mode + power button in "+getminutes()+":"+getseconds()),secs--,timeout=setTimeout("Decrement()",1e3))}function getminutes(){return mins=Math.floor(secs/60),twoDigits(mins)}function getseconds(){return twoDigits(secs-Math.round(60*mins))}var defaultCFG_URL="syscfg/SYSCFG.TXT",SYSCFG,parameters,defaultParameters,version,userLoaded,acceptedFirmware=[59,113,117];$(document).ready(function(){$.get(defaultCFG_URL,function(a){SYSCFG=a,updateParameters(),defaultParameters=parameters,displaySettings()});var a=document.getElementById("drop_area");a.addEventListener("dragover",handleDragOver,!1),a.addEventListener("dragleave",handleDragLeave,!1),a.addEventListener("drop",handleFileSelect,!1),$(".button").click(applySettings),$("[data-minFw=59]").hide(),$("[data-minFw=113]").hide(),$("[data-minFw=117]").hide()});var timeout,secs,mins;